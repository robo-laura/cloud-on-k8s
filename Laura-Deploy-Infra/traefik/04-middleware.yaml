---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: laura-middleware-chain
spec:
  chain:
    middlewares:
    #- name: hulk-ip-whitelist
    - name: laura-limit-concurrent
    - name: laura-circuit-breaker
    - name: laura-security
# ---
# apiVersion: traefik.containo.us/v1alpha1
# kind: Middleware
# metadata:
#   name: hulk-ip-whitelist
# spec:
#   ipWhiteList:
#     sourceRange:
#       - 127.0.0.1/32
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: laura-limit-concurrent
spec:
  inFlightReq:
    amount: 10
    sourceCriterion:
      ipStrategy:
        depth: 1
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: laura-circuit-breaker
spec:
  circuitBreaker:
    expression: "LatencyAtQuantileMS(50.0) > 500 || ResponseCodeRatio(400,600,0,600) > 0.25"
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: laura-apm-ratelimit
spec:
  rateLimit:
    average: 100
    burst: 50
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: laura-security
spec:
  headers:
    frameDeny: true
    #sslRedirect: true
    browserXssFilter: true
    contentTypeNosniff: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000
    forceSTSHeader: true
    accessControlAllowMethods:
      - "GET"
      - "OPTIONS"
      - "PUT"
    # accessControlAllowOriginList:
    #   - "https://foo.bar.org"
    #   - "https://example.org"
    accessControlMaxAge: 100
    #addVaryHeader: true
    #contentSecurityPolicy: "script-src 'self' ;base-uri 'none' ;form-action 'none' ;default-src 'unsafe-inline' "
    customResponseHeaders:
      Permissions-Policy: "geolocation=(self), microphone=(), camera=(), fullscreen=*"